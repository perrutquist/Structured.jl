using StructuredOutputs: system, user, assistant, response_format, get_choices, OneOf, WithTopLogprobs, get_probability
using OpenAI, JSON3

"The result of a coin flip"
struct CoinFlipBool
    "true for heads, false for tails"
    result::WithTopLogprobs{Bool}
end

sample_response = JSON3.read("{\"status\":200,\"response\":{\"id\":\"chatcmpl-AAbrJwGjTA2bON6ikcH91jMg49LSu\",\"object\":\"chat.completion\",\"created\":1727092173,\"model\":\"gpt-4o-2024-08-06\",\"choices\":[{\"index\":0,\"message\":{\"role\":\"assistant\",\"content\":\"{\\\"result\\\":true}\",\"refusal\":null},\"logprobs\":{\"content\":[{\"token\":\"{\\\"\",\"logprob\":-9.0883464e-7,\"bytes\":[123,34],\"top_logprobs\":[{\"token\":\"{\\\"\",\"logprob\":-9.0883464e-7,\"bytes\":[123,34]},{\"token\":\"{\",\"logprob\":-14.250001,\"bytes\":[123]},{\"token\":\"{\\n\",\"logprob\":-16.25,\"bytes\":[123,10]},{\"token\":\" {\\\"\",\"logprob\":-19.25,\"bytes\":[32,123,34]},{\"token\":\"\\n\",\"logprob\":-21.125,\"bytes\":[10]},{\"token\":\"{\\r\\n\",\"logprob\":-22.5,\"bytes\":[123,13,10]},{\"token\":\"{\\n\\n\",\"logprob\":-22.625,\"bytes\":[123,10,10]}]},{\"token\":\"result\",\"logprob\":0,\"bytes\":[114,101,115,117,108,116],\"top_logprobs\":[{\"token\":\"result\",\"logprob\":0,\"bytes\":[114,101,115,117,108,116]},{\"token\":\"re\",\"logprob\":-17.75,\"bytes\":[114,101]},{\"token\":\"res\",\"logprob\":-18.875,\"bytes\":[114,101,115]},{\"token\":\"r\",\"logprob\":-19.0625,\"bytes\":[114]},{\"token\":\"!\",\"logprob\":-100,\"bytes\":[33]},{\"token\":\"\\\"\",\"logprob\":-100,\"bytes\":[34]},{\"token\":\"#\",\"logprob\":-100,\"bytes\":[35]},{\"token\":\"\$\",\"logprob\":-100,\"bytes\":[36]}]},{\"token\":\"\\\":\",\"logprob\":0,\"bytes\":[34,58],\"top_logprobs\":[{\"token\":\"\\\":\",\"logprob\":0,\"bytes\":[34,58]},{\"token\":\"\\\"\",\"logprob\":-18.6875,\"bytes\":[34]},{\"token\":\"\\\":\\n\",\"logprob\":-20.5625,\"bytes\":[34,58,10]},{\"token\":\"\\\":\\n\\n\",\"logprob\":-21.3125,\"bytes\":[34,58,10,10]},{\"token\":\"\\\":\\r\\n\",\"logprob\":-21.875,\"bytes\":[34,58,13,10]},{\"token\":\"\\\"\\n\",\"logprob\":-24.5,\"bytes\":[34,10]},{\"token\":\"\\\"\\n\\n\",\"logprob\":-25.125,\"bytes\":[34,10,10]},{\"token\":\"\\\"\\r\\n\",\"logprob\":-28.65625,\"bytes\":[34,13,10]}]},{\"token\":\"true\",\"logprob\":-0.20157677,\"bytes\":[116,114,117,101],\"top_logprobs\":[{\"token\":\"true\",\"logprob\":-0.20157677,\"bytes\":[116,114,117,101]},{\"token\":\"false\",\"logprob\":-1.7015767,\"bytes\":[102,97,108,115,101]},{\"token\":\" true\",\"logprob\":-8.951577,\"bytes\":[32,116,114,117,101]},{\"token\":\" false\",\"logprob\":-10.326577,\"bytes\":[32,102,97,108,115,101]},{\"token\":\"tru\",\"logprob\":-14.639077,\"bytes\":[116,114,117]},{\"token\":\"\\ttrue\",\"logprob\":-15.139077,\"bytes\":[9,116,114,117,101]},{\"token\":\"tr\",\"logprob\":-15.764077,\"bytes\":[116,114]},{\"token\":\"\\tfalse\",\"logprob\":-16.014076,\"bytes\":[9,102,97,108,115,101]}]},{\"token\":\"}\",\"logprob\":-1.9361265e-7,\"bytes\":[125],\"top_logprobs\":[{\"token\":\"}\",\"logprob\":-1.9361265e-7,\"bytes\":[125]},{\"token\":\"}\\n\",\"logprob\":-15.75,\"bytes\":[125,10]},{\"token\":\"}\\n\\n\",\"logprob\":-17.75,\"bytes\":[125,10,10]},{\"token\":\" }\",\"logprob\":-19.125,\"bytes\":[32,125]},{\"token\":\"}\\n\\n\\n\",\"logprob\":-20.125,\"bytes\":[125,10,10,10]},{\"token\":\"}\\r\\n\",\"logprob\":-24.875,\"bytes\":[125,13,10]},{\"token\":\"}\\n\\n\\n\\n\",\"logprob\":-25.5,\"bytes\":[125,10,10,10,10]},{\"token\":\"}\\n\\n\\n\\n\\n\\n\",\"logprob\":-26.625,\"bytes\":[125,10,10,10,10,10,10]}]}],\"refusal\":null},\"finish_reason\":\"stop\"},{\"index\":1,\"message\":{\"role\":\"assistant\",\"content\":\"{\\\"result\\\":true}\",\"refusal\":null},\"logprobs\":{\"content\":[{\"token\":\"{\\\"\",\"logprob\":-9.0883464e-7,\"bytes\":[123,34],\"top_logprobs\":[{\"token\":\"{\\\"\",\"logprob\":-9.0883464e-7,\"bytes\":[123,34]},{\"token\":\"{\",\"logprob\":-14.250001,\"bytes\":[123]},{\"token\":\"{\\n\",\"logprob\":-16.25,\"bytes\":[123,10]},{\"token\":\" {\\\"\",\"logprob\":-19.25,\"bytes\":[32,123,34]},{\"token\":\"\\n\",\"logprob\":-21.125,\"bytes\":[10]},{\"token\":\"{\\r\\n\",\"logprob\":-22.5,\"bytes\":[123,13,10]},{\"token\":\"{\\n\\n\",\"logprob\":-22.625,\"bytes\":[123,10,10]}]},{\"token\":\"result\",\"logprob\":0,\"bytes\":[114,101,115,117,108,116],\"top_logprobs\":[{\"token\":\"result\",\"logprob\":0,\"bytes\":[114,101,115,117,108,116]},{\"token\":\"re\",\"logprob\":-17.75,\"bytes\":[114,101]},{\"token\":\"res\",\"logprob\":-18.875,\"bytes\":[114,101,115]},{\"token\":\"r\",\"logprob\":-19.0625,\"bytes\":[114]},{\"token\":\"!\",\"logprob\":-100,\"bytes\":[33]},{\"token\":\"\\\"\",\"logprob\":-100,\"bytes\":[34]},{\"token\":\"#\",\"logprob\":-100,\"bytes\":[35]},{\"token\":\"\$\",\"logprob\":-100,\"bytes\":[36]}]},{\"token\":\"\\\":\",\"logprob\":0,\"bytes\":[34,58],\"top_logprobs\":[{\"token\":\"\\\":\",\"logprob\":0,\"bytes\":[34,58]},{\"token\":\"\\\"\",\"logprob\":-18.6875,\"bytes\":[34]},{\"token\":\"\\\":\\n\",\"logprob\":-20.5625,\"bytes\":[34,58,10]},{\"token\":\"\\\":\\n\\n\",\"logprob\":-21.3125,\"bytes\":[34,58,10,10]},{\"token\":\"\\\":\\r\\n\",\"logprob\":-21.875,\"bytes\":[34,58,13,10]},{\"token\":\"\\\"\\n\",\"logprob\":-24.5,\"bytes\":[34,10]},{\"token\":\"\\\"\\n\\n\",\"logprob\":-25.125,\"bytes\":[34,10,10]},{\"token\":\"\\\"\\r\\n\",\"logprob\":-28.65625,\"bytes\":[34,13,10]}]},{\"token\":\"true\",\"logprob\":-0.20157677,\"bytes\":[116,114,117,101],\"top_logprobs\":[{\"token\":\"true\",\"logprob\":-0.20157677,\"bytes\":[116,114,117,101]},{\"token\":\"false\",\"logprob\":-1.7015767,\"bytes\":[102,97,108,115,101]},{\"token\":\" true\",\"logprob\":-8.951577,\"bytes\":[32,116,114,117,101]},{\"token\":\" false\",\"logprob\":-10.326577,\"bytes\":[32,102,97,108,115,101]},{\"token\":\"tru\",\"logprob\":-14.639077,\"bytes\":[116,114,117]},{\"token\":\"\\ttrue\",\"logprob\":-15.139077,\"bytes\":[9,116,114,117,101]},{\"token\":\"tr\",\"logprob\":-15.764077,\"bytes\":[116,114]},{\"token\":\"\\tfalse\",\"logprob\":-16.014076,\"bytes\":[9,102,97,108,115,101]}]},{\"token\":\"}\",\"logprob\":-1.9361265e-7,\"bytes\":[125],\"top_logprobs\":[{\"token\":\"}\",\"logprob\":-1.9361265e-7,\"bytes\":[125]},{\"token\":\"}\\n\",\"logprob\":-15.75,\"bytes\":[125,10]},{\"token\":\"}\\n\\n\",\"logprob\":-17.75,\"bytes\":[125,10,10]},{\"token\":\" }\",\"logprob\":-19.125,\"bytes\":[32,125]},{\"token\":\"}\\n\\n\\n\",\"logprob\":-20.125,\"bytes\":[125,10,10,10]},{\"token\":\"}\\r\\n\",\"logprob\":-24.875,\"bytes\":[125,13,10]},{\"token\":\"}\\n\\n\\n\\n\",\"logprob\":-25.5,\"bytes\":[125,10,10,10,10]},{\"token\":\"}\\n\\n\\n\\n\\n\\n\",\"logprob\":-26.625,\"bytes\":[125,10,10,10,10,10,10]}]}],\"refusal\":null},\"finish_reason\":\"stop\"}],\"usage\":{\"prompt_tokens\":78,\"completion_tokens\":10,\"total_tokens\":88,\"completion_tokens_details\":{\"reasoning_tokens\":0}},\"system_fingerprint\":\"fp_5050236cbd\"}}")

sample_response_vector = JSON3.read("{\"status\":200,\"response\":{\"id\":\"chatcmpl-A7z0hqnVKEzp8ULNoMNBQRR7X1w62\",\"object\":\"chat.completion\",\"created\":1726466183,\"model\":\"gpt-4o-2024-08-06\",\"choices\":[{\"index\":0,\"message\":{\"role\":\"assistant\",\"content\":\"{\\\"result\\\":\\\"tails\\\"}\",\"refusal\":null},\"logprobs\":{\"content\":[{\"token\":\"{\\\"\",\"logprob\":-1.9361265e-7,\"bytes\":[123,34],\"top_logprobs\":[{\"token\":\"{\\\"\",\"logprob\":-1.9361265e-7,\"bytes\":[123,34]},{\"token\":\"{\",\"logprob\":-15.75,\"bytes\":[123]},{\"token\":\"{\\n\",\"logprob\":-17.5,\"bytes\":[123,10]},{\"token\":\" {\\\"\",\"logprob\":-19,\"bytes\":[32,123,34]},{\"token\":\"\\n\",\"logprob\":-19.5,\"bytes\":[10]},{\"token\":\"\\n\\n\",\"logprob\":-23.625,\"bytes\":[10,10]},{\"token\":\" \",\"logprob\":-24.125,\"bytes\":[32]}]},{\"token\":\"result\",\"logprob\":0,\"bytes\":[114,101,115,117,108,116],\"top_logprobs\":[{\"token\":\"result\",\"logprob\":0,\"bytes\":[114,101,115,117,108,116]},{\"token\":\"re\",\"logprob\":-18.625,\"bytes\":[114,101]},{\"token\":\"r\",\"logprob\":-18.75,\"bytes\":[114]},{\"token\":\"res\",\"logprob\":-20,\"bytes\":[114,101,115]},{\"token\":\"!\",\"logprob\":-100,\"bytes\":[33]},{\"token\":\"\\\"\",\"logprob\":-100,\"bytes\":[34]},{\"token\":\"#\",\"logprob\":-100,\"bytes\":[35]},{\"token\":\"\$\",\"logprob\":-100,\"bytes\":[36]}]},{\"token\":\"\\\":\\\"\",\"logprob\":-5.5122365e-7,\"bytes\":[34,58,34],\"top_logprobs\":[{\"token\":\"\\\":\\\"\",\"logprob\":-5.5122365e-7,\"bytes\":[34,58,34]},{\"token\":\"\\\":\",\"logprob\":-14.625001,\"bytes\":[34,58]},{\"token\":\"\\\"\",\"logprob\":-20.25,\"bytes\":[34]},{\"token\":\"\\\":\\n\",\"logprob\":-24.9375,\"bytes\":[34,58,10]},{\"token\":\"\\\":\\n\\n\",\"logprob\":-26.0625,\"bytes\":[34,58,10,10]},{\"token\":\"\\\":\\r\\n\",\"logprob\":-28.1875,\"bytes\":[34,58,13,10]},{\"token\":\"\\\"\\n\",\"logprob\":-28.8125,\"bytes\":[34,10]},{\"token\":\"\\\"\\n\\n\",\"logprob\":-30.375,\"bytes\":[34,10,10]}]},{\"token\":\"tails\",\"logprob\":-0.5231803,\"bytes\":[116,97,105,108,115],\"top_logprobs\":[{\"token\":\"tails\",\"logprob\":-0.5231803,\"bytes\":[116,97,105,108,115]},{\"token\":\"heads\",\"logprob\":-0.8981803,\"bytes\":[104,101,97,100,115]},{\"token\":\"tail\",\"logprob\":-10.52318,\"bytes\":[116,97,105,108]},{\"token\":\"head\",\"logprob\":-10.64818,\"bytes\":[104,101,97,100]},{\"token\":\"t\",\"logprob\":-12.64818,\"bytes\":[116]},{\"token\":\"ta\",\"logprob\":-13.39818,\"bytes\":[116,97]},{\"token\":\"he\",\"logprob\":-13.96068,\"bytes\":[104,101]},{\"token\":\"h\",\"logprob\":-14.39818,\"bytes\":[104]}]},{\"token\":\"\\\"}\",\"logprob\":0,\"bytes\":[34,125],\"top_logprobs\":[{\"token\":\"\\\"}\",\"logprob\":0,\"bytes\":[34,125]},{\"token\":\"\\\"}\\n\\n\",\"logprob\":-16.875,\"bytes\":[34,125,10,10]},{\"token\":\"\\\"}\\n\",\"logprob\":-17.875,\"bytes\":[34,125,10]},{\"token\":\"\\\"\",\"logprob\":-19.25,\"bytes\":[34]},{\"token\":\"\\\"\\n\",\"logprob\":-34.25,\"bytes\":[34,10]},{\"token\":\"\\\"\\n\\n\",\"logprob\":-34.9375,\"bytes\":[34,10,10]},{\"token\":\"\\\"\\n\\n\\n\",\"logprob\":-35.875,\"bytes\":[34,10,10,10]},{\"token\":\"\\\"\\r\\n\",\"logprob\":-40.28125,\"bytes\":[34,13,10]}]}],\"refusal\":null},\"finish_reason\":\"stop\"},{\"index\":1,\"message\":{\"role\":\"assistant\",\"content\":\"{\\\"result\\\":\\\"heads\\\"}\",\"refusal\":null},\"logprobs\":{\"content\":[{\"token\":\"{\\\"\",\"logprob\":-1.9361265e-7,\"bytes\":[123,34],\"top_logprobs\":[{\"token\":\"{\\\"\",\"logprob\":-1.9361265e-7,\"bytes\":[123,34]},{\"token\":\"{\",\"logprob\":-15.75,\"bytes\":[123]},{\"token\":\"{\\n\",\"logprob\":-17.5,\"bytes\":[123,10]},{\"token\":\" {\\\"\",\"logprob\":-19,\"bytes\":[32,123,34]},{\"token\":\"\\n\",\"logprob\":-19.5,\"bytes\":[10]},{\"token\":\"\\n\\n\",\"logprob\":-23.625,\"bytes\":[10,10]},{\"token\":\" \",\"logprob\":-24.125,\"bytes\":[32]}]},{\"token\":\"result\",\"logprob\":0,\"bytes\":[114,101,115,117,108,116],\"top_logprobs\":[{\"token\":\"result\",\"logprob\":0,\"bytes\":[114,101,115,117,108,116]},{\"token\":\"re\",\"logprob\":-18.625,\"bytes\":[114,101]},{\"token\":\"r\",\"logprob\":-18.75,\"bytes\":[114]},{\"token\":\"res\",\"logprob\":-20,\"bytes\":[114,101,115]},{\"token\":\"!\",\"logprob\":-100,\"bytes\":[33]},{\"token\":\"\\\"\",\"logprob\":-100,\"bytes\":[34]},{\"token\":\"#\",\"logprob\":-100,\"bytes\":[35]},{\"token\":\"\$\",\"logprob\":-100,\"bytes\":[36]}]},{\"token\":\"\\\":\\\"\",\"logprob\":-5.5122365e-7,\"bytes\":[34,58,34],\"top_logprobs\":[{\"token\":\"\\\":\\\"\",\"logprob\":-5.5122365e-7,\"bytes\":[34,58,34]},{\"token\":\"\\\":\",\"logprob\":-14.625001,\"bytes\":[34,58]},{\"token\":\"\\\"\",\"logprob\":-20.25,\"bytes\":[34]},{\"token\":\"\\\":\\n\",\"logprob\":-24.9375,\"bytes\":[34,58,10]},{\"token\":\"\\\":\\n\\n\",\"logprob\":-26.0625,\"bytes\":[34,58,10,10]},{\"token\":\"\\\":\\r\\n\",\"logprob\":-28.1875,\"bytes\":[34,58,13,10]},{\"token\":\"\\\"\\n\",\"logprob\":-28.8125,\"bytes\":[34,10]},{\"token\":\"\\\"\\n\\n\",\"logprob\":-30.375,\"bytes\":[34,10,10]}]},{\"token\":\"heads\",\"logprob\":-0.8981803,\"bytes\":[104,101,97,100,115],\"top_logprobs\":[{\"token\":\"tails\",\"logprob\":-0.5231803,\"bytes\":[116,97,105,108,115]},{\"token\":\"heads\",\"logprob\":-0.8981803,\"bytes\":[104,101,97,100,115]},{\"token\":\"tail\",\"logprob\":-10.52318,\"bytes\":[116,97,105,108]},{\"token\":\"head\",\"logprob\":-10.64818,\"bytes\":[104,101,97,100]},{\"token\":\"t\",\"logprob\":-12.64818,\"bytes\":[116]},{\"token\":\"ta\",\"logprob\":-13.39818,\"bytes\":[116,97]},{\"token\":\"he\",\"logprob\":-13.96068,\"bytes\":[104,101]},{\"token\":\"h\",\"logprob\":-14.39818,\"bytes\":[104]}]},{\"token\":\"\\\"}\",\"logprob\":0,\"bytes\":[34,125],\"top_logprobs\":[{\"token\":\"\\\"}\",\"logprob\":0,\"bytes\":[34,125]},{\"token\":\"\\\"}\\n\\n\",\"logprob\":-16.875,\"bytes\":[34,125,10,10]},{\"token\":\"\\\"}\\n\",\"logprob\":-17.5,\"bytes\":[34,125,10]},{\"token\":\"\\\"\",\"logprob\":-19.25,\"bytes\":[34]},{\"token\":\"\\\"\\n\",\"logprob\":-34.0625,\"bytes\":[34,10]},{\"token\":\"\\\"\\n\\n\",\"logprob\":-35,\"bytes\":[34,10,10]},{\"token\":\"\\\"\\n\\n\\n\",\"logprob\":-35.875,\"bytes\":[34,10,10,10]},{\"token\":\"\\\"\\r\\n\",\"logprob\":-40.1875,\"bytes\":[34,13,10]}]}],\"refusal\":null},\"finish_reason\":\"stop\"}],\"usage\":{\"prompt_tokens\":64,\"completion_tokens\":10,\"total_tokens\":74,\"completion_tokens_details\":{\"reasoning_tokens\":0}},\"system_fingerprint\":\"fp_143bb8492c\"}}")

response = if get(ENV, "TEST_WITH_OPENAI", "false") == "true"
    println("Calling OpenAI.")
    OpenAI.create_chat(
        ENV["OPENAI_API_KEY"],
        "gpt-4o-2024-08-06",
        [ system => "You are a coin-flipping assistant.",
        user => "Please flip a coin for me. Respond in JSON format." ],
        response_format = response_format(CoinFlipBool),
        logprobs = true,
        top_logprobs = 8, # Max 20
        n = 2
    )
else
    println("Reusing sample response.")
    sample_response
end

chs = get_choices(CoinFlipBool, response)

@show get_probability(chs[1].result, true) # 0.817 ...
