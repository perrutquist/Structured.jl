using StructuredOutputs: system, user, assistant, response_format, get_choices, OneOf, WithTopLogprobs, get_probability
using OpenAI, JSON3

const Flip = WithTopLogprobs{OneOf{(:heads, :tails)}}

sample_response = JSON3.read("{\"status\":200,\"response\":{\"id\":\"chatcmpl-AAd3y0oZ1eC59c2REfiSAX9colm3v\",\"object\":\"chat.completion\",\"created\":1727096802,\"model\":\"gpt-4o-2024-08-06\",\"choices\":[{\"index\":0,\"message\":{\"role\":\"assistant\",\"content\":\"{\\\"response\\\":[\\\"tails\\\",\\\"heads\\\",\\\"tails\\\"]}\",\"refusal\":null},\"logprobs\":{\"content\":[{\"token\":\"{\\\"\",\"logprob\":-7.9418505e-6,\"bytes\":[123,34],\"top_logprobs\":[{\"token\":\"{\\\"\",\"logprob\":-7.9418505e-6,\"bytes\":[123,34]},{\"token\":\"{\",\"logprob\":-16.750008,\"bytes\":[123]},{\"token\":\"{\\n\",\"logprob\":-17.500008,\"bytes\":[123,10]},{\"token\":\" {\\\"\",\"logprob\":-19.500008,\"bytes\":[32,123,34]},{\"token\":\"\\n\",\"logprob\":-22.000008,\"bytes\":[10]},{\"token\":\"\\n\\n\",\"logprob\":-24.625008,\"bytes\":[10,10]},{\"token\":\"{\\n\\n\",\"logprob\":-25.125008,\"bytes\":[123,10,10]}]},{\"token\":\"response\",\"logprob\":0,\"bytes\":[114,101,115,112,111,110,115,101],\"top_logprobs\":[{\"token\":\"response\",\"logprob\":0,\"bytes\":[114,101,115,112,111,110,115,101]},{\"token\":\"re\",\"logprob\":-18.625,\"bytes\":[114,101]},{\"token\":\"r\",\"logprob\":-19.125,\"bytes\":[114]},{\"token\":\"respons\",\"logprob\":-19.875,\"bytes\":[114,101,115,112,111,110,115]},{\"token\":\"res\",\"logprob\":-21.125,\"bytes\":[114,101,115]},{\"token\":\"resp\",\"logprob\":-22.375,\"bytes\":[114,101,115,112]},{\"token\":\"!\",\"logprob\":-100,\"bytes\":[33]},{\"token\":\"\\\"\",\"logprob\":-100,\"bytes\":[34]}]},{\"token\":\"\\\":[\\\"\",\"logprob\":-3.1281633e-7,\"bytes\":[34,58,91,34],\"top_logprobs\":[{\"token\":\"\\\":[\\\"\",\"logprob\":-3.1281633e-7,\"bytes\":[34,58,91,34]},{\"token\":\"\\\":[\",\"logprob\":-15.625,\"bytes\":[34,58,91]},{\"token\":\"\\\":\",\"logprob\":-16.25,\"bytes\":[34,58]},{\"token\":\"\\\":[]\",\"logprob\":-18.25,\"bytes\":[34,58,91,93]},{\"token\":\"\\\"\",\"logprob\":-23.375,\"bytes\":[34]},{\"token\":\"\\\":\\n\\n\",\"logprob\":-26.625,\"bytes\":[34,58,10,10]},{\"token\":\"\\\":\\n\",\"logprob\":-27.25,\"bytes\":[34,58,10]},{\"token\":\"\\\":\\r\\n\",\"logprob\":-29.375,\"bytes\":[34,58,13,10]}]},{\"token\":\"tails\",\"logprob\":-0.6932126,\"bytes\":[116,97,105,108,115],\"top_logprobs\":[{\"token\":\"tails\",\"logprob\":-0.6932126,\"bytes\":[116,97,105,108,115]},{\"token\":\"heads\",\"logprob\":-0.6932126,\"bytes\":[104,101,97,100,115]},{\"token\":\"head\",\"logprob\":-10.1932125,\"bytes\":[104,101,97,100]},{\"token\":\"tail\",\"logprob\":-10.6932125,\"bytes\":[116,97,105,108]},{\"token\":\"t\",\"logprob\":-12.8182125,\"bytes\":[116]},{\"token\":\"ta\",\"logprob\":-13.8182125,\"bytes\":[116,97]},{\"token\":\"he\",\"logprob\":-13.9432125,\"bytes\":[104,101]},{\"token\":\"h\",\"logprob\":-14.6307125,\"bytes\":[104]}]},{\"token\":\"\\\",\\\"\",\"logprob\":-9.0883464e-7,\"bytes\":[34,44,34],\"top_logprobs\":[{\"token\":\"\\\",\\\"\",\"logprob\":-9.0883464e-7,\"bytes\":[34,44,34]},{\"token\":\"\\\"]\",\"logprob\":-14.000001,\"bytes\":[34,93]},{\"token\":\"\\\",\",\"logprob\":-18.5,\"bytes\":[34,44]},{\"token\":\"\\\"\",\"logprob\":-21.375,\"bytes\":[34]},{\"token\":\"\\\"]}\\n\",\"logprob\":-23.125,\"bytes\":[34,93,125,10]},{\"token\":\"\\\",\\n\",\"logprob\":-24.625,\"bytes\":[34,44,10]},{\"token\":\"\\\"]\\n\\n\",\"logprob\":-27,\"bytes\":[34,93,10,10]},{\"token\":\"\\\"]\\n\",\"logprob\":-27.25,\"bytes\":[34,93,10]}]},{\"token\":\"heads\",\"logprob\":-0.16033511,\"bytes\":[104,101,97,100,115],\"top_logprobs\":[{\"token\":\"heads\",\"logprob\":-0.16033511,\"bytes\":[104,101,97,100,115]},{\"token\":\"tails\",\"logprob\":-1.9103351,\"bytes\":[116,97,105,108,115]},{\"token\":\"head\",\"logprob\":-9.410336,\"bytes\":[104,101,97,100]},{\"token\":\"tail\",\"logprob\":-10.660336,\"bytes\":[116,97,105,108]},{\"token\":\"t\",\"logprob\":-13.035336,\"bytes\":[116]},{\"token\":\"he\",\"logprob\":-13.285336,\"bytes\":[104,101]},{\"token\":\"ta\",\"logprob\":-14.222836,\"bytes\":[116,97]},{\"token\":\"h\",\"logprob\":-14.347836,\"bytes\":[104]}]},{\"token\":\"\\\",\\\"\",\"logprob\":0,\"bytes\":[34,44,34],\"top_logprobs\":[{\"token\":\"\\\",\\\"\",\"logprob\":0,\"bytes\":[34,44,34]},{\"token\":\"\\\"]\",\"logprob\":-19,\"bytes\":[34,93]},{\"token\":\"\\\"\",\"logprob\":-21,\"bytes\":[34]},{\"token\":\"\\\",\",\"logprob\":-21.375,\"bytes\":[34,44]},{\"token\":\"\\\"]}\\n\",\"logprob\":-25.875,\"bytes\":[34,93,125,10]},{\"token\":\"\\\",\\n\",\"logprob\":-27,\"bytes\":[34,44,10]},{\"token\":\"\\\"]\\n\\n\",\"logprob\":-27.625,\"bytes\":[34,93,10,10]},{\"token\":\"\\\"]\\n\",\"logprob\":-29.5,\"bytes\":[34,93,10]}]},{\"token\":\"tails\",\"logprob\":-0.974131,\"bytes\":[116,97,105,108,115],\"top_logprobs\":[{\"token\":\"heads\",\"logprob\":-0.47413102,\"bytes\":[104,101,97,100,115]},{\"token\":\"tails\",\"logprob\":-0.974131,\"bytes\":[116,97,105,108,115]},{\"token\":\"head\",\"logprob\":-10.224131,\"bytes\":[104,101,97,100]},{\"token\":\"tail\",\"logprob\":-11.099131,\"bytes\":[116,97,105,108]},{\"token\":\"t\",\"logprob\":-13.724131,\"bytes\":[116]},{\"token\":\"ta\",\"logprob\":-14.224131,\"bytes\":[116,97]},{\"token\":\"he\",\"logprob\":-14.474131,\"bytes\":[104,101]},{\"token\":\"h\",\"logprob\":-15.849131,\"bytes\":[104]}]},{\"token\":\"\\\"]\",\"logprob\":-3.1281633e-7,\"bytes\":[34,93],\"top_logprobs\":[{\"token\":\"\\\"]\",\"logprob\":-3.1281633e-7,\"bytes\":[34,93]},{\"token\":\"\\\"]}\\n\",\"logprob\":-15.25,\"bytes\":[34,93,125,10]},{\"token\":\"\\\",\\\"\",\"logprob\":-20.375,\"bytes\":[34,44,34]},{\"token\":\"\\\"\",\"logprob\":-20.625,\"bytes\":[34]},{\"token\":\"\\\",\",\"logprob\":-23.875,\"bytes\":[34,44]},{\"token\":\"\\\"]\\n\\n\",\"logprob\":-27.125,\"bytes\":[34,93,10,10]},{\"token\":\"\\\"]\\n\",\"logprob\":-27.1875,\"bytes\":[34,93,10]},{\"token\":\"\\\"]\\r\\n\",\"logprob\":-29.5,\"bytes\":[34,93,13,10]}]},{\"token\":\"}\",\"logprob\":-1.9361265e-7,\"bytes\":[125],\"top_logprobs\":[{\"token\":\"}\",\"logprob\":-1.9361265e-7,\"bytes\":[125]},{\"token\":\"}\\n\\n\",\"logprob\":-15.625,\"bytes\":[125,10,10]},{\"token\":\"}\\n\\n\\n\",\"logprob\":-18.375,\"bytes\":[125,10,10,10]},{\"token\":\" }\",\"logprob\":-20.625,\"bytes\":[32,125]},{\"token\":\"}\\r\\n\",\"logprob\":-22.375,\"bytes\":[125,13,10]},{\"token\":\"}\\n\\n\\n\\n\",\"logprob\":-22.875,\"bytes\":[125,10,10,10,10]},{\"token\":\"}\\n\",\"logprob\":-23.75,\"bytes\":[125,10]},{\"token\":\"}\\r\\n\\r\\n\",\"logprob\":-23.75,\"bytes\":[125,13,10,13,10]}]}],\"refusal\":null},\"finish_reason\":\"stop\"},{\"index\":1,\"message\":{\"role\":\"assistant\",\"content\":\"{\\\"response\\\":[\\\"tails\\\",\\\"heads\\\",\\\"tails\\\"]}\",\"refusal\":null},\"logprobs\":{\"content\":[{\"token\":\"{\\\"\",\"logprob\":-7.9418505e-6,\"bytes\":[123,34],\"top_logprobs\":[{\"token\":\"{\\\"\",\"logprob\":-7.9418505e-6,\"bytes\":[123,34]},{\"token\":\"{\",\"logprob\":-16.750008,\"bytes\":[123]},{\"token\":\"{\\n\",\"logprob\":-17.500008,\"bytes\":[123,10]},{\"token\":\" {\\\"\",\"logprob\":-19.500008,\"bytes\":[32,123,34]},{\"token\":\"\\n\",\"logprob\":-22.000008,\"bytes\":[10]},{\"token\":\"\\n\\n\",\"logprob\":-24.625008,\"bytes\":[10,10]},{\"token\":\"{\\n\\n\",\"logprob\":-25.125008,\"bytes\":[123,10,10]}]},{\"token\":\"response\",\"logprob\":0,\"bytes\":[114,101,115,112,111,110,115,101],\"top_logprobs\":[{\"token\":\"response\",\"logprob\":0,\"bytes\":[114,101,115,112,111,110,115,101]},{\"token\":\"re\",\"logprob\":-18.625,\"bytes\":[114,101]},{\"token\":\"r\",\"logprob\":-19.125,\"bytes\":[114]},{\"token\":\"respons\",\"logprob\":-19.875,\"bytes\":[114,101,115,112,111,110,115]},{\"token\":\"res\",\"logprob\":-21.125,\"bytes\":[114,101,115]},{\"token\":\"resp\",\"logprob\":-22.375,\"bytes\":[114,101,115,112]},{\"token\":\"!\",\"logprob\":-100,\"bytes\":[33]},{\"token\":\"\\\"\",\"logprob\":-100,\"bytes\":[34]}]},{\"token\":\"\\\":[\\\"\",\"logprob\":-3.1281633e-7,\"bytes\":[34,58,91,34],\"top_logprobs\":[{\"token\":\"\\\":[\\\"\",\"logprob\":-3.1281633e-7,\"bytes\":[34,58,91,34]},{\"token\":\"\\\":[\",\"logprob\":-15.625,\"bytes\":[34,58,91]},{\"token\":\"\\\":\",\"logprob\":-16.25,\"bytes\":[34,58]},{\"token\":\"\\\":[]\",\"logprob\":-18.25,\"bytes\":[34,58,91,93]},{\"token\":\"\\\"\",\"logprob\":-23.375,\"bytes\":[34]},{\"token\":\"\\\":\\n\\n\",\"logprob\":-26.625,\"bytes\":[34,58,10,10]},{\"token\":\"\\\":\\n\",\"logprob\":-27.25,\"bytes\":[34,58,10]},{\"token\":\"\\\":\\r\\n\",\"logprob\":-29.375,\"bytes\":[34,58,13,10]}]},{\"token\":\"tails\",\"logprob\":-0.6932126,\"bytes\":[116,97,105,108,115],\"top_logprobs\":[{\"token\":\"tails\",\"logprob\":-0.6932126,\"bytes\":[116,97,105,108,115]},{\"token\":\"heads\",\"logprob\":-0.6932126,\"bytes\":[104,101,97,100,115]},{\"token\":\"head\",\"logprob\":-10.1932125,\"bytes\":[104,101,97,100]},{\"token\":\"tail\",\"logprob\":-10.6932125,\"bytes\":[116,97,105,108]},{\"token\":\"t\",\"logprob\":-12.8182125,\"bytes\":[116]},{\"token\":\"ta\",\"logprob\":-13.8182125,\"bytes\":[116,97]},{\"token\":\"he\",\"logprob\":-13.9432125,\"bytes\":[104,101]},{\"token\":\"h\",\"logprob\":-14.6307125,\"bytes\":[104]}]},{\"token\":\"\\\",\\\"\",\"logprob\":-9.0883464e-7,\"bytes\":[34,44,34],\"top_logprobs\":[{\"token\":\"\\\",\\\"\",\"logprob\":-9.0883464e-7,\"bytes\":[34,44,34]},{\"token\":\"\\\"]\",\"logprob\":-14.000001,\"bytes\":[34,93]},{\"token\":\"\\\",\",\"logprob\":-18.5,\"bytes\":[34,44]},{\"token\":\"\\\"\",\"logprob\":-21.375,\"bytes\":[34]},{\"token\":\"\\\"]}\\n\",\"logprob\":-23.125,\"bytes\":[34,93,125,10]},{\"token\":\"\\\",\\n\",\"logprob\":-24.625,\"bytes\":[34,44,10]},{\"token\":\"\\\"]\\n\\n\",\"logprob\":-27,\"bytes\":[34,93,10,10]},{\"token\":\"\\\"]\\n\",\"logprob\":-27.25,\"bytes\":[34,93,10]}]},{\"token\":\"heads\",\"logprob\":-0.16033511,\"bytes\":[104,101,97,100,115],\"top_logprobs\":[{\"token\":\"heads\",\"logprob\":-0.16033511,\"bytes\":[104,101,97,100,115]},{\"token\":\"tails\",\"logprob\":-1.9103351,\"bytes\":[116,97,105,108,115]},{\"token\":\"head\",\"logprob\":-9.410336,\"bytes\":[104,101,97,100]},{\"token\":\"tail\",\"logprob\":-10.660336,\"bytes\":[116,97,105,108]},{\"token\":\"t\",\"logprob\":-13.035336,\"bytes\":[116]},{\"token\":\"he\",\"logprob\":-13.285336,\"bytes\":[104,101]},{\"token\":\"ta\",\"logprob\":-14.222836,\"bytes\":[116,97]},{\"token\":\"h\",\"logprob\":-14.347836,\"bytes\":[104]}]},{\"token\":\"\\\",\\\"\",\"logprob\":0,\"bytes\":[34,44,34],\"top_logprobs\":[{\"token\":\"\\\",\\\"\",\"logprob\":0,\"bytes\":[34,44,34]},{\"token\":\"\\\"]\",\"logprob\":-19,\"bytes\":[34,93]},{\"token\":\"\\\"\",\"logprob\":-21,\"bytes\":[34]},{\"token\":\"\\\",\",\"logprob\":-21.375,\"bytes\":[34,44]},{\"token\":\"\\\"]}\\n\",\"logprob\":-25.875,\"bytes\":[34,93,125,10]},{\"token\":\"\\\",\\n\",\"logprob\":-27,\"bytes\":[34,44,10]},{\"token\":\"\\\"]\\n\\n\",\"logprob\":-27.625,\"bytes\":[34,93,10,10]},{\"token\":\"\\\"]\\n\",\"logprob\":-29.5,\"bytes\":[34,93,10]}]},{\"token\":\"tails\",\"logprob\":-0.974131,\"bytes\":[116,97,105,108,115],\"top_logprobs\":[{\"token\":\"heads\",\"logprob\":-0.47413102,\"bytes\":[104,101,97,100,115]},{\"token\":\"tails\",\"logprob\":-0.974131,\"bytes\":[116,97,105,108,115]},{\"token\":\"head\",\"logprob\":-10.224131,\"bytes\":[104,101,97,100]},{\"token\":\"tail\",\"logprob\":-11.099131,\"bytes\":[116,97,105,108]},{\"token\":\"t\",\"logprob\":-13.724131,\"bytes\":[116]},{\"token\":\"ta\",\"logprob\":-14.224131,\"bytes\":[116,97]},{\"token\":\"he\",\"logprob\":-14.474131,\"bytes\":[104,101]},{\"token\":\"h\",\"logprob\":-15.849131,\"bytes\":[104]}]},{\"token\":\"\\\"]\",\"logprob\":-3.1281633e-7,\"bytes\":[34,93],\"top_logprobs\":[{\"token\":\"\\\"]\",\"logprob\":-3.1281633e-7,\"bytes\":[34,93]},{\"token\":\"\\\"]}\\n\",\"logprob\":-15.25,\"bytes\":[34,93,125,10]},{\"token\":\"\\\",\\\"\",\"logprob\":-20.375,\"bytes\":[34,44,34]},{\"token\":\"\\\"\",\"logprob\":-20.625,\"bytes\":[34]},{\"token\":\"\\\",\",\"logprob\":-23.875,\"bytes\":[34,44]},{\"token\":\"\\\"]\\n\\n\",\"logprob\":-27.125,\"bytes\":[34,93,10,10]},{\"token\":\"\\\"]\\n\",\"logprob\":-27.1875,\"bytes\":[34,93,10]},{\"token\":\"\\\"]\\r\\n\",\"logprob\":-29.5,\"bytes\":[34,93,13,10]}]},{\"token\":\"}\",\"logprob\":-1.9361265e-7,\"bytes\":[125],\"top_logprobs\":[{\"token\":\"}\",\"logprob\":-1.9361265e-7,\"bytes\":[125]},{\"token\":\"}\\n\\n\",\"logprob\":-15.625,\"bytes\":[125,10,10]},{\"token\":\"}\\n\\n\\n\",\"logprob\":-18.375,\"bytes\":[125,10,10,10]},{\"token\":\" }\",\"logprob\":-20.625,\"bytes\":[32,125]},{\"token\":\"}\\r\\n\",\"logprob\":-22.375,\"bytes\":[125,13,10]},{\"token\":\"}\\n\\n\\n\\n\",\"logprob\":-22.875,\"bytes\":[125,10,10,10,10]},{\"token\":\"}\\n\",\"logprob\":-23.75,\"bytes\":[125,10]},{\"token\":\"}\\r\\n\\r\\n\",\"logprob\":-23.75,\"bytes\":[125,13,10,13,10]}]}],\"refusal\":null},\"finish_reason\":\"stop\"}],\"usage\":{\"prompt_tokens\":70,\"completion_tokens\":20,\"total_tokens\":90,\"completion_tokens_details\":{\"reasoning_tokens\":0}},\"system_fingerprint\":\"fp_5050236cbd\"}}")

response = if get(ENV, "TEST_WITH_OPENAI", "false") == "true"
    println("Calling OpenAI.")
    OpenAI.create_chat(
        ENV["OPENAI_API_KEY"],
        "gpt-4o-2024-08-06",
        [ system => "You are a coin-flipping assistant.",
        user => "Please flip three coins for me. Respond in JSON format." ],
        response_format = response_format(@NamedTuple{(response::Vector{Flip})}),
        logprobs = true,
        top_logprobs = 8, # Max 20
        n = 2
    )
else
    println("Reusing sample response.")
    sample_response
end

chs = get_choices(@NamedTuple{(response::Vector{Flip})}, response)

@show get_probability(chs[1].response[1], :heads) # 0.499 ...
